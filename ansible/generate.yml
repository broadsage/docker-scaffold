# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage <opensource@broadsage.com>
#
# SPDX-License-Identifier: Apache-2.0
---
- name: Generate Docker scaffold project structure
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    scaffold_user: abc
    scaffold_group: abc

  pre_tasks:
    - name: Merge configuration files (defaults.yml + project.yml)
      tags: always
      ansible.builtin.command:
        cmd: python3 scripts/merge_config.py
        chdir: /app
      changed_when: false
      register: merge_result
    
    - name: Display merge output
      tags: always
      ansible.builtin.debug:
        var: merge_result.stdout_lines
      when: merge_result.stdout_lines is defined
    
    - name: Load merged configuration
      tags: always
      ansible.builtin.include_vars:
        file: "/tmp/merged_config.yml"

    - name: Set user ID from environment
      tags: always
      changed_when: false
      when: 
        - lookup('env', 'PUID') | length > 0
      ansible.builtin.user:
        name: "{{ scaffold_user }}"
        non_unique: true
        uid: "{{ lookup('env', 'PUID') | int }}"

    - name: Set group ID from environment
      tags: always
      changed_when: false
      when:
        - lookup('env', 'PGID') | length > 0
      ansible.builtin.group:
        name: "{{ scaffold_group }}"
        non_unique: true
        gid: "{{ lookup('env', 'PGID') | int }}"

  roles:
    - role: github
      tags: 
        - github
        
    - role: repository
      tags:
        - repository

  post_tasks:
    - name: Display scaffold completion message
      tags: always
      ansible.builtin.debug:
        msg: |
          âœ… Docker scaffold generation completed successfully!