# SPDX-FileCopyrightText: Copyright (c) {{ cookiecutter.maintainer_name }} <{{ cookiecutter.maintainer_email }}>
#
# SPDX-License-Identifier: {{ cookiecutter.license }}
---
name: Template Update Check

on:
  schedule:
    # Check for template updates every Monday at 9 AM UTC
    - cron: '0 9 * * MON'
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'Create PR if updates available'
        required: true
        default: false
        type: boolean

jobs:
  check-template-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Install Task
        uses: arduino/setup-task@v2
      
      - name: Check for template updates
        id: check
        run: |
          if [ -f project.yaml ]; then
            CURRENT=$(yq '.template.version // "unknown"' project.yaml)
          else
            CURRENT="unknown"
          fi
          
          docker pull ghcr.io/broadsage/scaffold:latest
          LATEST=$(docker run --rm ghcr.io/broadsage/scaffold:latest cat /app/VERSION 2>/dev/null || echo "latest")
          
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          
          if [ "$CURRENT" != "$LATEST" ] && [ "$CURRENT" != "latest" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::notice::Template update available: $CURRENT â†’ $LATEST"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "::notice::Template is up to date (version: $CURRENT)"
          fi
      
      - name: Get changelog
        if: steps.check.outputs.update_available == 'true'
        id: changelog
        run: |
          CHANGELOG=$(curl -sL https://raw.githubusercontent.com/broadsage/docker-scaffold/main/CHANGELOG.md | head -n 100)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create update branch
        if: steps.check.outputs.update_available == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b template-update-${{ steps.check.outputs.latest }}
      
      - name: Update template
        if: steps.check.outputs.update_available == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
        run: |
          # Update version in project.yaml
          yq -i '.template.version = "${{ steps.check.outputs.latest }}"' project.yaml
          
          # Create backup
          task backup
          
          # Regenerate files
          task generate
      
      - name: Create Pull Request
        if: steps.check.outputs.update_available == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: template-update-${{ steps.check.outputs.latest }}
          title: "chore: update template to v${{ steps.check.outputs.latest }}"
          body: |
            ## ðŸ”„ Template Update Available
            
            This PR updates the docker-scaffold template from `v${{ steps.check.outputs.current }}` to `v${{ steps.check.outputs.latest }}`.
            
            ### ðŸ“‹ Changes
            - Updated `project.yaml` template version
            - Regenerated project files using `task generate`
            - Backup created in `.backup/` directory
            
            ### ðŸ“– Changelog
            
            See the full [CHANGELOG.md](https://github.com/broadsage/docker-scaffold/blob/main/CHANGELOG.md)
            
            <details>
            <summary>Recent changes</summary>
            
            ```markdown
            ${{ steps.changelog.outputs.changelog }}
            ```
            
            </details>
            
            ### âœ… Review Checklist
            - [ ] Review generated file changes
            - [ ] Check protected files were not overwritten
            - [ ] Verify CI/CD passes
            - [ ] Test locally before merge
            - [ ] Review changelog for breaking changes
            
            ### ðŸ”„ Manual Update
            
            To update manually instead:
            
            ```bash
            task check-updates
            task update-template
            ```
            
            ---
            
            ðŸ¤– Auto-generated by template-sync workflow
          labels: |
            template-update
            dependencies
          draft: true
          delete-branch: true
      
      - name: Summary
        if: always()
        run: |
          echo "## Template Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version**: ${{ steps.check.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Version**: ${{ steps.check.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Available**: ${{ steps.check.outputs.update_available }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check.outputs.update_available }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with the template updates." >> $GITHUB_STEP_SUMMARY
            echo "Review the PR and merge when ready." >> $GITHUB_STEP_SUMMARY
          fi
