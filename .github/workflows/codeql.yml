# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage <opensource@broadsage.com>
#
# SPDX-License-Identifier: Apache-2.0

---
name: "CodeQL Advanced Security Scan"

"on":
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    # Run weekly on Mondays at midnight UTC for comprehensive security scanning
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # CodeQL deep security analysis for Python
  codeql-analysis:
    name: CodeQL
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["python"]
        # CodeQL provides deep SAST analysis for security vulnerabilities
        # Linting (style/format) is handled by MegaLinter in compliance workflow

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Initialize CodeQL
        uses: github/codeql-action/init@396bb3e45325a47dd9ef434068033c6d5bb0d11a # v4.1.1
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@396bb3e45325a47dd9ef434068033c6d5bb0d11a # v4.1.1

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@396bb3e45325a47dd9ef434068033c6d5bb0d11a # v4.1.1
        with:
          category: "/language:${{ matrix.language }}"

      - name: Security Scan Summary
        if: always()
        run: |
          {
            echo "## ðŸ”’ CodeQL Security Analysis"
            echo ""
            echo "### Python Security Scan"

            if [ "${{ job.status }}" == "success" ]; then
              echo "âœ… **Status:** Passed - No critical vulnerabilities detected"
            else
              echo "âŒ **Status:** Failed - Security issues found"
            fi

            echo ""
            echo "### ðŸ” What CodeQL Scans For"
            echo "- SQL Injection (CWE-89)"
            echo "- Cross-Site Scripting (CWE-79)"
            echo "- Command Injection (CWE-78)"
            echo "- Path Traversal (CWE-22)"
            echo "- Insecure Deserialization (CWE-502)"
            echo "- Hardcoded Credentials (CWE-798)"
            echo "- And 300+ other security patterns"
            echo ""
            echo "### â„¹ï¸ Note"
            echo "Code linting and style checks are handled by MegaLinter in the Compliance workflow"
            echo ""
            echo "### ðŸ”— Resources"
            echo "- [Security Policy](../../SECURITY.md)"
            echo "- [CodeQL Queries](https://codeql.github.com/codeql-query-help/python/)"
          } >> "$GITHUB_STEP_SUMMARY"
