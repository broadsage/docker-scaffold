# SPDX-FileCopyrightText: Copyright (c) 2025 Broadsage <opensource@broadsage.com>
#
# SPDX-License-Identifier: Apache-2.0
---
name: Dependabot Auto-Merge

"on":
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  # Check if PR is from Dependabot and determine auto-merge eligibility
  analyze:
    name: Analyze Dependabot PR
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    outputs:
      should-automerge: ${{ steps.decision.outputs.should-automerge }}
      ecosystem: ${{ steps.metadata.outputs.ecosystem }}
      update-type: ${{ steps.metadata.outputs.update-type }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Fetch Dependabot Metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine Auto-Merge Strategy
        id: decision
        run: |
          echo "Analyzing Dependabot PR..."
          echo "Ecosystem: ${{ steps.metadata.outputs.package-ecosystem }}"
          echo "Update Type: ${{ steps.metadata.outputs.update-type }}"

          ECOSYSTEM="${{ steps.metadata.outputs.package-ecosystem }}"
          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"

          # Auto-merge decision logic based on ecosystem and update type
          SHOULD_AUTOMERGE="false"

          case "$ECOSYSTEM" in
            "github-actions")
              # GitHub Actions: Auto-merge all updates (low risk, well-sandboxed)
              if [[ "$UPDATE_TYPE" =~ ^version-update:semver-(patch|minor|major)$ ]]; then
                SHOULD_AUTOMERGE="true"
                echo "‚úÖ GitHub Actions update - safe to auto-merge"
              fi
              ;;

            "docker")
              # Docker: Auto-merge patch and minor only
              if [[ "$UPDATE_TYPE" =~ ^version-update:semver-(patch|minor)$ ]]; then
                SHOULD_AUTOMERGE="true"
                echo "‚úÖ Docker patch/minor update - safe to auto-merge"
              else
                echo "‚ö†Ô∏è  Docker major update - requires manual review"
              fi
              ;;

            "pip")
              # Python: Auto-merge patch updates only
              if [[ "$UPDATE_TYPE" == "version-update:semver-patch" ]]; then
                SHOULD_AUTOMERGE="true"
                echo "‚úÖ Python patch update - safe to auto-merge"
              else
                echo "‚ö†Ô∏è  Python minor/major update - requires manual review"
              fi
              ;;

            *)
              echo "‚ö†Ô∏è  Unknown ecosystem - requires manual review"
              ;;
          esac

          echo "should-automerge=$SHOULD_AUTOMERGE" >> "$GITHUB_OUTPUT"
          echo ""
          echo "üìã Summary:"
          echo "  Ecosystem: $ECOSYSTEM"
          echo "  Update Type: $UPDATE_TYPE"
          echo "  Auto-merge: $SHOULD_AUTOMERGE"

  # Auto-approve the PR if eligible
  approve:
    name: Auto-Approve PR
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.should-automerge == 'true'

    permissions:
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Approve Pull Request
        run: |
          gh pr review "$PR_URL" --approve --body "ü§ñ **Auto-approved by Dependabot Auto-Merge**

          This ${{ needs.analyze.outputs.ecosystem }} ${{ needs.analyze.outputs.update-type }} has been automatically approved.

          ‚úÖ Will auto-merge once all required checks pass.

          ---
          *If you need to make changes, push new commits to override this approval.*"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Enable GitHub's auto-merge feature
  enable-automerge:
    name: Enable Auto-Merge
    runs-on: ubuntu-latest
    needs: [analyze, approve]
    if: needs.analyze.outputs.should-automerge == 'true'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Enable Auto-Merge
        run: |
          gh pr merge "$PR_URL" --auto --squash --delete-branch
          echo "‚úÖ Auto-merge enabled - will merge when all checks pass"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ecosystem = '${{ needs.analyze.outputs.ecosystem }}';
            const updateType = '${{ needs.analyze.outputs.update-type }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ü§ñ Dependabot Auto-Merge Enabled

              This **${ecosystem}** update has been configured for automatic merging.

              ### üìä Details
              - **Ecosystem**: ${ecosystem}
              - **Update Type**: ${updateType}
              - **Strategy**: Auto-merge enabled

              ### ‚è≥ Next Steps
              1. ‚úÖ Wait for all required status checks to pass
              2. ‚úÖ PR will automatically merge via squash
              3. ‚úÖ Branch will be automatically deleted

              ### üõë To Cancel Auto-Merge
              If you need to review this manually, run:
              \`\`\`bash
              gh pr merge ${{ github.event.pull_request.number }} --disable-auto
              \`\`\`

              ---
              *Powered by [Dependabot Auto-Merge Workflow](../.github/workflows/dependabot-automerge.yaml)*`
            });

  # Summary job for manual review cases
  manual-review-required:
    name: Manual Review Required
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.should-automerge == 'false'

    steps:
      - name: Comment on PR
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ecosystem = '${{ needs.analyze.outputs.ecosystem }}';
            const updateType = '${{ needs.analyze.outputs.update-type }}';

            let reason = '';
            if (ecosystem === 'docker' && updateType.includes('major')) {
              reason = 'Docker major version updates may contain breaking changes';
            } else if (ecosystem === 'pip' && !updateType.includes('patch')) {
              reason = 'Python minor/major updates should be tested for compatibility';
            } else {
              reason = 'This update type requires manual review';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## üëÄ Manual Review Required

              This **${ecosystem}** update requires manual review before merging.

              ### üìä Details
              - **Ecosystem**: ${ecosystem}
              - **Update Type**: ${updateType}
              - **Reason**: ${reason}

              ### üîç Review Checklist
              - [ ] Review the changelog for breaking changes
              - [ ] Verify all CI checks pass
              - [ ] Test locally if needed
              - [ ] Approve and merge when ready

              ### ‚úÖ To Approve
              Once reviewed, you can approve and merge:
              \`\`\`bash
              gh pr review ${{ github.event.pull_request.number }} --approve
              gh pr merge ${{ github.event.pull_request.number }} --squash
              \`\`\`

              ---
              *Powered by [Dependabot Auto-Merge Workflow](../.github/workflows/dependabot-automerge.yaml)*`
            });
